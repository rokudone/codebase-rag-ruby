# コードベースRAGシステムの精度向上

コードベースRAGシステムの精度を向上させるための改善を5つのフェーズに分けて実装しました。

## フェーズ1: 基盤強化

基本的なモデルとパラメータの強化を行いました。

- **エンベディングモデルのアップグレード**: `text-embedding-3-small` から `text-embedding-3-large` へ
- **LLMモデルのアップグレード**: `gpt-4o-mini` から `gpt-4o` へ
- **システムプロンプトの改善**: より構造化された回答を促すプロンプトに改善
- **検索結果の拡大**: 取得数を10から20に増加

## フェーズ2: 検索強化

検索の精度と多様性を向上させる機能を実装しました。

### クエリ拡張機能

```ruby
# lib/codebase_rag/domain/services/query_expander.rb
```

- 質問を分析し、関連するキーワードや概念を追加
- LLMを使用して質問の意図を理解し、検索クエリを拡張
- 専門用語や同義語の追加によるカバレッジ向上

### 再ランキング機能

```ruby
# lib/codebase_rag/domain/services/reranker.rb
```

- LLMを使用して検索結果の関連性を再評価
- 質問の意図に基づいて検索結果を並べ替え
- 文脈的な関連性を考慮した順位付け

### ハイブリッド検索

- ベクトル検索とキーワード検索の組み合わせ
- 意味的類似性と正確なキーワードマッチングの両方を活用
- 検索結果の多様性と網羅性の向上

## フェーズ3: コンテキスト最適化

検索結果から生成するコンテキストの質を向上させました。

### コンテキスト構築の改善

```ruby
# lib/codebase_rag/domain/services/context_builder.rb
```

- 階層的なコンテキスト構造: コードベース概要、ファイル情報、チャンク情報
- ファイルごとのグループ化: 同じファイルのチャンクをグループ化
- Markdownフォーマット: コードブロックや見出しを使用した構造化
- 情報密度の最適化: 限られたコンテキスト長で最大限の情報を提供

### メタデータ強化

```ruby
# lib/codebase_rag/domain/entities/code_chunk.rb
# lib/codebase_rag/domain/services/chunker.rb
```

- 親子関係の追跡: クラス・モジュール・メソッド間の階層関係を明示的に保持
- 依存関係の抽出: 継承、ミックスイン、メソッド呼び出しなどの依存関係を抽出
- コンテキスト情報の強化: 親情報を含めたより詳細なコンテキスト情報

## フェーズ4: チャンキング改善

コードの分割方法を改善し、より意味のあるチャンクを生成しました。

### セマンティックチャンキング

```ruby
# lib/codebase_rag/domain/services/semantic_chunker.rb
```

- 関連するメソッドをグループ化して機能的なまとまりでチャンクを生成
- LLMを活用した関連メソッドのグループ化
- 親情報と依存関係の継承
- 進捗表示機能の追加: ファイルごとの処理状況、メソッド数、グループ化の進行状況

### 階層的チャンキングの強化

```ruby
# lib/codebase_rag/domain/services/hierarchy_visualizer.rb
```

- チャンクの階層構造を視覚化
- 依存関係の表示
- Markdown形式とJSON形式での出力

## フェーズ5: 評価とフィードバック

システムの評価と改善のためのフィードバックループを実装しました。

### 評価指標の導入

```ruby
# lib/codebase_rag/domain/services/evaluator.rb
```

- 多角的な評価指標: 関連性、正確性、完全性、簡潔性、コード参照
- LLMを活用した自動評価
- 評価結果のログ記録
- 評価統計の集計

### フィードバックループの導入

```ruby
# lib/codebase_rag/domain/services/feedback_collector.rb
```

- フィードバックID: 各回答に一意のIDを付与
- 5段階評価: ユーザーが1〜5の評価を提供可能
- コメント機能: 評価に加えてコメントも記録可能
- フィードバック統計: 平均評価や分布を表示

## 使用方法

### 評価モード

```bash
# 評価モードを有効にして質問を実行
rb-rag query "質問文" --data ./rag-data --evaluate

# 評価結果を集計して表示
rb-rag evaluate --data ./rag-data
```

### フィードバックモード

```bash
# フィードバックモードを有効にして質問を実行
rb-rag query "質問文" --data ./rag-data --feedback

# フィードバックを提供
rb-rag feedback abc12345 4 --comment "とても役立ちました"

# フィードバック統計を表示
rb-rag feedback-stats --data ./rag-data
```

## 期待される効果

これらの改善により、以下の効果が期待されます：

1. **より正確な検索結果**: 関連性の高いコードチャンクを優先的に取得
2. **より豊かなコンテキスト**: コードの関係性や依存関係を明確に提示
3. **より構造化された回答**: 質問に対する直接的な回答から詳細な説明まで段階的に提供
4. **継続的な改善の仕組み**: 評価とフィードバックによる品質向上
5. **処理の透明性向上**: 詳細な進捗表示によるプロセスの可視化

これにより、「ピントが外れている」という課題が解決され、より精度の高いコードベースRAGシステムが実現しました。
